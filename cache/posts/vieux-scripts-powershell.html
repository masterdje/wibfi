<p class="alert alert-info">Collection de scripts qui ont fait le boulot mais dont l'approche est probablement dépassée...</p>
<ul class="simple">
<li>Mais j'avais quand même envie de les garder sous le coude...</li>
</ul>
<!-- TEASER_END -->
<div class="section" id="lister-les-machines-d-un-domaine">
<h2>Lister les machines d'un domaine</h2>
<pre class="code powershell literal-block">
<span class="nv">$filtre</span> <span class="p">=</span> <span class="s2">&quot;(objectCategory=Computer)&quot;</span>
<span class="nv">$domaine</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">System</span><span class="p">.</span><span class="n">DirectoryServices</span><span class="p">.</span><span class="n">DirectoryEntry</span>
<span class="nv">$chercheur</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">System</span><span class="p">.</span><span class="n">DirectoryServices</span><span class="p">.</span><span class="n">DirectorySearcher</span>
<span class="nv">$chercheur</span><span class="p">.</span><span class="n">SearchRoot</span> <span class="p">=</span> <span class="nv">$domaine</span>
<span class="nv">$chercheur</span><span class="p">.</span><span class="n">PageSize</span> <span class="p">=</span> <span class="n">1000</span>
<span class="nv">$chercheur</span><span class="p">.</span><span class="k">Filter</span> <span class="p">=</span> <span class="nv">$filtre</span>

<span class="c"># Ajout de la propriété que l'on recherche...</span>
<span class="nv">$prop</span> <span class="p">=</span> <span class="s2">&quot;name&quot;</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$i</span> <span class="k">in</span> <span class="nv">$prop</span><span class="p">){</span><span class="nv">$chercheur</span><span class="p">.</span><span class="n">PropertiesToLoad</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="nv">$i</span><span class="p">)}</span>

<span class="nv">$colResults</span> <span class="p">=</span> <span class="nv">$chercheur</span><span class="p">.</span><span class="n">FindAll</span><span class="p">()</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nv">$objResult</span> <span class="k">in</span> <span class="nv">$colResults</span><span class="p">)</span> <span class="p">{</span>
<span class="nv">$objItem</span> <span class="p">=</span> <span class="nv">$objResult</span><span class="p">.</span><span class="n">Properties</span>
<span class="c"># Sortie vers l'écran</span>
<span class="nb">write-host</span> <span class="nv">$objItem</span><span class="p">.</span><span class="n">name</span>
<span class="p">}</span>
</pre>
</div>
<div class="section" id="ping-v1">
<h2>Ping v1</h2>
<pre class="code powershell literal-block">
<span class="nv">$ping</span> <span class="p">=</span> <span class="nb">new-object</span> <span class="n">System</span><span class="p">.</span><span class="n">Net</span><span class="p">.</span><span class="n">Networkinformation</span><span class="p">.</span><span class="n">Ping</span>
<span class="nv">$ping</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;[nom du serveur]&quot;</span><span class="p">)</span>
</pre>
</div>
<div class="section" id="ping-v2">
<h2>Ping v2</h2>
<pre class="code powershell literal-block">
<span class="nv">$ping</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="err">«</span> <span class="no">[nm du serveur]</span><span class="err">«</span> <span class="p">).</span><span class="n">status</span>
</pre>
</div>
<div class="section" id="ping-d-une-plage-d-ip">
<h2>Ping d'une plage d'IP</h2>
<pre class="code powershell literal-block">
<span class="nv">$ping</span> <span class="p">=</span> <span class="nb">new-object</span> <span class="n">system</span><span class="p">.</span><span class="n">net</span><span class="p">.</span><span class="n">networkinformation</span><span class="p">.</span><span class="n">ping</span> <span class="err">;</span> <span class="n">10</span><span class="p">..</span><span class="n">20</span> <span class="p">|</span> <span class="k">foreach</span> <span class="p">{</span> <span class="nv">$ip</span> <span class="p">=</span> <span class="s2">&quot;XXX.XXX.$_.XXX&quot;</span> <span class="err">;</span> <span class="nv">$ping</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="nv">$ip</span><span class="p">)</span> <span class="p">}</span> <span class="p">|</span><span class="n">select</span> <span class="n">Address</span><span class="p">,</span> <span class="n">Status</span>
</pre>
</div>
<div class="section" id="nslookup-d-une-plage-d-ip">
<h2>Nslookup d'une plage d'IP</h2>
<pre class="code powershell literal-block">
<span class="n">1</span><span class="p">..</span><span class="n">255</span> <span class="p">|</span> <span class="p">%</span> <span class="p">{</span> <span class="no">[System.Net.Dns]</span><span class="err">::</span><span class="n">GetHostByAddress</span><span class="p">(</span><span class="s2">&quot;XXX.XXX.XXX.$_&quot;</span><span class="p">)</span> <span class="p">}</span> <span class="n">2</span><span class="p">&gt;</span> <span class="nb">Out-Null</span> <span class="p">|</span> <span class="n">ft</span>
</pre>
</div>
<div class="section" id="rajout-dune-plage-dexclusion-dhcp-pour-chaque-scope-dhcp">
<h2>Rajout d’une plage d’exclusion DHCP pour chaque scope DHCP</h2>
<ul class="simple">
<li>Attention, deux serveurs dhcp...</li>
<li>Rediriger la sortie vers un .bat</li>
</ul>
<pre class="code powershell literal-block">
<span class="nv">$scopes</span><span class="p">=</span><span class="err">&#64;</span><span class="p">(</span><span class="n">101</span><span class="p">,</span><span class="n">103</span><span class="p">,</span><span class="n">104</span><span class="p">,</span><span class="n">111</span><span class="p">,</span><span class="n">112</span><span class="p">,</span><span class="n">113</span><span class="p">,</span><span class="n">114</span><span class="p">,</span><span class="n">121</span><span class="p">,</span><span class="n">122</span><span class="p">,</span><span class="n">123</span><span class="p">,</span><span class="n">124</span><span class="p">,</span><span class="n">131</span><span class="p">,</span><span class="n">132</span><span class="p">,</span><span class="n">133</span><span class="p">,</span><span class="n">134</span><span class="p">,</span><span class="n">141</span><span class="p">,</span><span class="n">142</span><span class="p">,</span><span class="n">143</span><span class="p">,</span><span class="n">144</span><span class="p">,</span><span class="n">151</span><span class="p">,</span><span class="n">152</span><span class="p">,</span><span class="n">153</span><span class="p">,</span><span class="n">154</span><span class="p">)</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$scope</span> <span class="k">in</span> <span class="nv">$scopes</span><span class="p">){</span><span class="n">1</span><span class="p">..</span><span class="n">2</span> <span class="p">|</span> <span class="p">%</span> <span class="p">{</span><span class="s2">&quot;netsh dhcp server \\[ServeurDHCP]$_ scope XXX.$scope.0.0 add excluderange XXX.$scope.2.0 XXX.$scope.2.0&quot;</span><span class="p">}}</span>
</pre>
</div>
<div class="section" id="ping-des-controleurs-de-domaine">
<h2>Ping des controleurs de domaine</h2>
<pre class="code powershell literal-block">
<span class="nv">$ping</span> <span class="p">=</span> <span class="nb">new-object</span> <span class="n">System</span><span class="p">.</span><span class="n">Net</span><span class="p">.</span><span class="n">Networkinformation</span><span class="p">.</span><span class="n">Ping</span>
<span class="nv">$objDomain</span> <span class="p">=</span> <span class="no">[System.DirectoryServices.ActiveDirectory.Domain]</span><span class="err">::</span><span class="n">GetCurrentDomain</span><span class="p">()</span>
<span class="nv">$dc</span><span class="p">=</span><span class="nv">$objDomain</span><span class="p">.</span><span class="n">FindAllDomainControllers</span><span class="p">()</span> <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">Name</span><span class="p">,</span><span class="n">IpAddress</span> <span class="p">|</span><span class="n">sort</span> <span class="n">name</span>
<span class="k">for</span> <span class="p">(</span><span class="nv">$i</span><span class="p">=</span><span class="n">0</span><span class="err">;</span> <span class="nv">$i</span> <span class="o">-le</span> <span class="nv">$dc</span><span class="p">.</span><span class="n">count</span><span class="p">-</span><span class="n">1</span> <span class="err">;</span><span class="nv">$i</span><span class="p">++)</span> <span class="p">{</span>
        <span class="nb">Write-Host</span> <span class="n">-ForegroundColor</span> <span class="s2">&quot;white&quot;</span> <span class="nv">$dc</span><span class="p">[</span><span class="nv">$i</span><span class="p">].</span><span class="n">name</span> <span class="n">-NoNewLine</span> <span class="s2">&quot; - IP-&gt; &quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$ping</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="nv">$dc</span><span class="p">[</span><span class="nv">$i</span><span class="p">].</span><span class="n">name</span><span class="p">).</span><span class="n">status</span> <span class="o">-eq</span> <span class="s2">&quot;success&quot;</span> <span class="p">)</span>
        <span class="p">{</span> <span class="nb">Write-Host</span> <span class="n">-ForegroundColor</span> <span class="s2">&quot;green&quot;</span> <span class="n">-NoNewLine</span> <span class="nv">$dc</span><span class="p">[</span><span class="nv">$i</span><span class="p">].</span><span class="n">ipaddress</span><span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span> <span class="nb">Write-Host</span> <span class="n">-ForegroundColor</span> <span class="s2">&quot;red&quot;</span> <span class="n">-NoNewLine</span> <span class="nv">$dc</span><span class="p">[</span><span class="nv">$i</span><span class="p">].</span><span class="n">ipaddress</span><span class="p">}</span>
        <span class="nb">Write-Host</span> <span class="n">-ForegroundColor</span> <span class="s2">&quot;white&quot;</span> <span class="n">-NoNewLine</span> <span class="s2">&quot; - R-&gt; &quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$dc</span><span class="p">[</span><span class="nv">$i</span><span class="p">].</span><span class="n">name</span><span class="p">.</span><span class="n">substring</span><span class="p">(</span><span class="n">0</span><span class="p">,</span><span class="n">2</span><span class="p">)</span> <span class="o">-eq</span> <span class="s2">&quot;cm&quot;</span><span class="p">)</span>
        <span class="p">{</span><span class="nv">$ip</span><span class="p">=</span><span class="nv">$dc</span><span class="p">[</span><span class="nv">$i</span><span class="p">].</span><span class="n">Ipaddress</span><span class="p">.</span><span class="n">substring</span><span class="p">(</span><span class="n">0</span><span class="p">,</span><span class="nv">$dc</span><span class="p">[</span><span class="nv">$i</span><span class="p">].</span><span class="n">Ipaddress</span><span class="p">.</span><span class="n">length</span> <span class="p">-</span><span class="n">3</span><span class="p">)</span> <span class="p">+</span> <span class="s2">&quot;XXX&quot;</span><span class="err">;</span>    <span class="c">#&lt;- à modifier pour votre pattern à vous</span>
                <span class="k">if</span> <span class="p">(</span><span class="nv">$ping</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="nv">$ip</span><span class="p">).</span><span class="n">status</span> <span class="o">-eq</span> <span class="s2">&quot;success&quot;</span> <span class="p">)</span>
                <span class="p">{</span> <span class="nb">Write-Host</span> <span class="n">-ForegroundColor</span> <span class="s2">&quot;green&quot;</span> <span class="nv">$ip</span><span class="p">}</span>
                <span class="k">else</span>
                <span class="p">{</span> <span class="nb">Write-Host</span> <span class="n">-ForegroundColor</span> <span class="s2">&quot;red&quot;</span> <span class="nv">$ip</span><span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
        <span class="nv">$Config</span> <span class="p">=</span> <span class="nb">Get-Wmiobject</span> <span class="n">win32_NetworkAdapterConfiguration</span> <span class="n">-comp</span> <span class="nv">$dc</span><span class="p">[</span><span class="nv">$i</span><span class="p">].</span><span class="n">name</span>
        <span class="k">for</span> <span class="p">(</span><span class="nv">$j</span><span class="p">=</span><span class="n">0</span><span class="err">;</span> <span class="nv">$j</span> <span class="o">-le</span> <span class="nv">$config</span><span class="p">.</span><span class="n">count</span> <span class="p">-</span><span class="n">1</span><span class="err">;</span><span class="nv">$j</span><span class="p">++)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nv">$config</span><span class="p">[</span><span class="nv">$j</span><span class="p">].</span><span class="n">IPAddress</span> <span class="o">-ne</span> <span class="nv">$null</span> <span class="p">){</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nv">$ping</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="nv">$config</span><span class="p">[</span><span class="nv">$j</span><span class="p">].</span><span class="n">DefaultIPGateway</span><span class="p">).</span><span class="n">status</span> <span class="o">-eq</span> <span class="s2">&quot;success&quot;</span> <span class="p">)</span>
                        <span class="p">{</span> <span class="nb">Write-Host</span> <span class="n">-ForegroundColor</span> <span class="s2">&quot;green&quot;</span> <span class="nv">$config</span><span class="p">[</span><span class="nv">$j</span><span class="p">].</span><span class="n">DefaultIPGateway</span><span class="p">}</span>
                        <span class="k">else</span>
                        <span class="p">{</span> <span class="nb">Write-Host</span> <span class="n">-ForegroundColor</span> <span class="s2">&quot;red&quot;</span> <span class="nv">$config</span><span class="p">[</span><span class="nv">$j</span><span class="p">].</span><span class="n">DefaultIPGateway</span><span class="p">}</span>
                <span class="p">}</span>
        <span class="p">}</span>
        <span class="p">}</span>
<span class="p">}</span>
</pre>
</div>
<div class="section" id="acces-a-une-cle-de-registre">
<h2>Accès à une clé de Registre</h2>
<pre class="code powershell literal-block">
<span class="nv">$key</span><span class="p">=</span> <span class="nb">get-item</span> <span class="s2">&quot;HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\&quot;</span>
</pre>
</div>
<div class="section" id="acces-a-une-propriete-dune-cle-de-registre">
<h2>Accès à une propriété d’une clé de Registre</h2>
<pre class="code powershell literal-block">
<span class="nv">$key</span><span class="p">=</span> <span class="nb">get-item</span> <span class="s2">&quot;HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\&quot;</span>
<span class="nv">$val</span><span class="p">=</span> <span class="nb">get-itemProperty</span> <span class="nv">$key</span><span class="p">.</span><span class="n">PSPath</span> <span class="p">|</span><span class="n">select</span> <span class="n">ProductName</span>
</pre>
</div>
<div class="section" id="creation-unitaire-dune-file-dimpression">
<h2>Création unitaire d’une file d’impression</h2>
<pre class="code powershell literal-block">
<span class="nv">$Name</span><span class="p">=</span><span class="s2">&quot;IMP-machintruc&quot;</span>
<span class="nv">$Comment</span><span class="p">=</span><span class="s2">&quot;Patati...&quot;</span>
<span class="nv">$Emplacement</span><span class="p">=</span><span class="s2">&quot;Bureau XXX&quot;</span>
<span class="nv">$DriverName</span> <span class="p">=</span> <span class="s2">&quot;Lexmark Universal XL&quot;</span> <span class="c">#&lt;== Tres important !!</span>
<span class="nv">$IPAddress</span> <span class="p">=</span> <span class="s2">&quot;192.168.XXX.XXX&quot;</span>
<span class="nv">$PortName</span> <span class="p">=</span> <span class="s2">&quot;Port-IPXXX&quot;</span>

<span class="c"># creation du port</span>
<span class="nv">$ClassIPPrnPort</span><span class="p">=</span> <span class="no">[wmiclass]</span><span class="s1">'Win32_TCPIPPrinterPort'</span>
<span class="nv">$NewPort</span><span class="p">=</span> <span class="nv">$ClassIPPrnPort</span><span class="p">.</span><span class="n">CreateInstance</span><span class="p">()</span>
<span class="nv">$NewPort</span><span class="p">.</span><span class="n">HostAddress</span> <span class="p">=</span> <span class="nv">$IPAddress</span>
<span class="nv">$NewPort</span><span class="p">.</span><span class="n">Name</span> <span class="p">=</span> <span class="nv">$PortName</span>
<span class="nv">$NewPort</span><span class="p">.</span><span class="n">Protocol</span> <span class="p">=</span> <span class="n">1</span> <span class="c">#  1 = Raw, 2 = LPR</span>
<span class="nv">$NewPort</span><span class="p">.</span><span class="n">SNMPEnabled</span> <span class="p">=</span> <span class="nv">$false</span>
<span class="nv">$ResultPort</span><span class="p">=</span><span class="nv">$NewPort</span><span class="p">.</span><span class="n">Put</span><span class="p">()</span>

<span class="c"># ajout de la file</span>
<span class="nv">$ClassPrinter</span><span class="p">=</span> <span class="no">[wmiclass]</span><span class="s1">'Win32_Printer'</span>
<span class="nv">$NewPrinter</span><span class="p">=</span> <span class="nv">$ClassPrinter</span><span class="p">.</span><span class="n">CreateInstance</span><span class="p">()</span>
<span class="nv">$NewPrinter</span><span class="p">.</span><span class="n">DriverName</span> <span class="p">=</span> <span class="nv">$DriverName</span>
<span class="nv">$NewPrinter</span><span class="p">.</span><span class="n">DeviceID</span> <span class="p">=</span> <span class="nv">$Name</span>
<span class="nv">$NewPrinter</span><span class="p">.</span><span class="n">PortName</span> <span class="p">=</span> <span class="nv">$PortName</span>
<span class="nv">$newprinter</span><span class="p">.</span><span class="n">Shared</span> <span class="p">=</span> <span class="nv">$true</span>
<span class="nv">$newprinter</span><span class="p">.</span><span class="n">Published</span> <span class="p">=</span> <span class="nv">$true</span>
<span class="nv">$newprinter</span><span class="p">.</span><span class="n">Sharename</span> <span class="p">=</span> <span class="nv">$Name</span>
<span class="nv">$newprinter</span><span class="p">.</span><span class="n">Location</span> <span class="p">=</span> <span class="nv">$Emplacement</span>
<span class="nv">$newprinter</span><span class="p">.</span><span class="n">Comment</span> <span class="p">=</span> <span class="nv">$Comment</span>

<span class="nv">$ResultPrinter</span><span class="p">=</span><span class="nv">$NewPrinter</span><span class="p">.</span><span class="n">Put</span><span class="p">()</span>
</pre>
</div>
<div class="section" id="liste-des-services-arretes-dune-machine-distante">
<h2>Liste des services arrêtés d’une machine distante</h2>
<pre class="code powershell literal-block">
<span class="nb">get-service</span> <span class="n">-computername</span> <span class="s2">&quot;ordXXXX&quot;</span> <span class="p">|</span> <span class="n">where</span> <span class="p">{</span><span class="nv">$_</span><span class="p">.</span><span class="n">status</span> <span class="o">-eq</span> <span class="s2">&quot;stopped&quot;</span> <span class="p">}</span>
</pre>
</div>
<div class="section" id="parcours-dun-tableau-concatenation-et-transtypage">
<h2>Parcours d’un tableau, concaténation et transtypage</h2>
<pre class="code powershell literal-block">
<span class="nv">$var</span><span class="p">=</span><span class="n">0</span><span class="p">..</span><span class="n">4</span><span class="err">;</span><span class="nv">$result</span><span class="p">=</span><span class="s2">&quot;&quot;</span><span class="err">;</span><span class="nv">$result</span><span class="p">=</span><span class="err">&#64;</span><span class="p">()</span> <span class="err">;</span> <span class="k">foreach</span> <span class="p">(</span><span class="nv">$val</span> <span class="k">in</span> <span class="nv">$var</span><span class="p">)</span> <span class="p">{</span><span class="nv">$result</span><span class="p">+=</span><span class="no">[int]</span><span class="p">(</span><span class="no">[string]</span><span class="nv">$val</span> <span class="p">+</span> <span class="s2">&quot;01&quot;</span><span class="p">)</span><span class="err">;</span><span class="p">}</span>
</pre>
</div>
