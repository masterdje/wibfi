<p class="alert alert-info">Quand il faut intervenir vite, bien, partout et surtout vite ...</p>
<ul class="simple">
<li>Par exemple lors du déploiement d'une version de pilote en v.XXX +1 parce que l'ancien n'aime pas la cohabitation 32b/64b</li>
</ul>
<!-- TEASER_END -->
<div class="section" id="code">
<h2>Code</h2>
<pre class="code powershell literal-block">
  <span class="c"># on cherche à remplacer l'info $oldriver par $newdriver sur toutes les files dont le nom contient le $pattern</span>

  <span class="nv">$newdriver</span> <span class="p">=</span> <span class="s2">&quot;Lexmark Universal v2 PS3&quot;</span>
  <span class="nv">$olddriver</span> <span class="p">=</span><span class="s2">&quot;Lexmark Universal v2&quot;</span>
  <span class="nv">$pattern</span> <span class="p">=</span> <span class="s2">&quot;%B5%&quot;</span>
  <span class="nv">$server</span> <span class="p">=</span> <span class="s2">&quot;monserveur01&quot;</span>
  <span class="nv">$printers</span> <span class="p">=</span> <span class="n">gwmi</span> <span class="n">-computername</span>  <span class="nv">$server</span> <span class="n">-query</span> <span class="s2">&quot;select * from win32_printer where name like '$pattern'&quot;</span>

  <span class="k">foreach</span><span class="p">(</span><span class="nv">$printer</span> <span class="k">in</span> <span class="nv">$printers</span><span class="p">){</span>
  <span class="nb">write-host</span> <span class="nv">$printer</span><span class="p">.</span><span class="n">name</span> <span class="nv">$printer</span><span class="p">.</span><span class="n">drivername</span>
  <span class="nv">$pilote</span> <span class="p">=</span> <span class="nv">$printer</span><span class="p">.</span><span class="n">drivername</span>
  <span class="nv">$name</span> <span class="p">=</span> <span class="nv">$printer</span><span class="p">.</span><span class="n">name</span>
<span class="k">if</span><span class="p">(</span><span class="nv">$pilote</span> <span class="o">-eq</span> <span class="nv">$olddriver</span><span class="p">){</span>
      <span class="p">&amp;</span> <span class="n">rundll32</span> <span class="n">printui</span><span class="p">.</span><span class="n">dll</span> <span class="n">PrintUIEntry</span> <span class="p">/</span><span class="n">Xs</span> <span class="p">/</span><span class="n">n</span> <span class="nv">$name</span> <span class="n">DriverName</span> <span class="nv">$newdriver</span>
<span class="nb">write-host</span> <span class="nv">$name</span> <span class="p">==&gt;</span> <span class="nv">$newdriver</span>
<span class="p">}</span>
  <span class="p">}</span>
</pre>
<ul class="simple">
<li>Exécution <strong>depuis</strong> le serveur seulement : j'ai tenté avec <em>invoke-command</em>, qui accepte l'exécution de <em>rundll32</em> mais ça fait pas le job... à creuser</li>
<li>et ça met un temps relativement long (+-20sec) à jouer la requete WMI, sur un serveur costaud et pas surchargé ... à creuser aussi</li>
</ul>
</div>
