<p class="alert alert-info">Mon lecteur d'ebook Kobo Glo sait correctement lire les fichiers .cbr et .cbz ... mais ceux-ci utilisent souvent des images au format Double-page,
peu adapté à la lecture en mode portrait.</p>
<ul class="simple">
<li>Une mission pour du <em>python</em> peu optimisé/cracra -aucune illusion à ce niveau là- , mais qui va se débrouiller pour conserver l'ordre des pages même après avoir découpé les doubles-pages en deux ...</li>
</ul>
<!-- TEASER_END -->
<script src="https://gist.github.com/6643474.js"></script><noscript><pre class="literal-block">
# Open any graphical ebook file ( cbr / cbz),
# and check every pic inside for anything in landscape mode, to cut it in half.
# Then reorder everything, and save the cbr/z as if nothing happened (huh huh)
#
# There are un bunch of more switchs (force b&amp;w render, reverse order (manga anyone ?), jump to page X etc) to play with.
#
# Mangasplit.py is still really -rough to the edge-
# Feel free to improve...


#!/usr/bin/python
from PIL import Image
from subprocess import call

import re
import sys
import string
import random
import os
import zipfile
import shutil
import getopt


def id_generator(size=6, chars=string.ascii_uppercase + string.digits):
	return ''.join(random.choice(chars) for x in range(size))

def makemydir(whatever):
  try:
    os.makedirs(whatever)
  except OSError:
    pass

def verboseprint (level,cvl,text):
	#currentverboselevel
	if ( cvl &gt;= level ) : print text
	return 

def conversionbw(filename, convertbw):
	if convertbw:
		img=Image.open(filename)
		img=img.convert('L')
		img.save(filename) 
		return &quot;+ Conversion NB de %s&quot; % filename
	else:
		return &quot;+ pas de conversion de %s&quot; % filename

def help():
	return &quot;mangasplit.py -i &lt;inputfile&gt; -s &lt;startpage&gt; -v &lt;verboselevel&gt; -r &lt;reversemode&gt; -c &lt;convert&gt;&quot;

def main(argv):
	inputfile=&quot;&quot;
	startpage=0
	reversemode=False
	convertbw=False
	cvl=1
				
	try:
		opts,args= getopt.getopt(argv,&quot;hi:s:v:rc&quot;,[&quot;help&quot;, &quot;ifile=&quot;,&quot;startpage=&quot;,&quot;verboselevel=&quot;])
	except getopt.GetoptError:
		verboseprint(0,cvl, help())
		
			
	for opt, arg in opts:
		if opt in ('-h','--help'):
			verboseprint(0,cvl, help())
			sys.exit()
		elif opt in (&quot;-i&quot;, &quot;--ifile&quot;):
			inputfile = arg
		elif opt in (&quot;-s&quot;,&quot;--startpage&quot;):
			startpage = int(arg)
		elif opt in (&quot;-v&quot;,&quot;--verboselevel&quot;):
			cvl = int(arg)			
		elif opt in (&quot;-r&quot;,&quot;--reversemode&quot;):
			reversemode = True
		elif opt in (&quot;-c&quot;,&quot;--convert&quot;):
			convertbw = True
		else:
			verboseprint(0,cvl, help())
			sys.exit(2)
	#check du fichier source
	if  not os.path.isfile(inputfile):
		verboseprint(0,cvl,&quot;&lt;!&gt; Fichier non trouve : %s&quot; % inputfile) ; 
		verboseprint(0,cvl, help())
		sys.exit(2)
	
	#check du fichier zip/cbz
	fullpathfile = os.path.abspath(inputfile)
	
	if zipfile.is_zipfile(fullpathfile):
		z = zipfile.ZipFile(fullpathfile)
	else:
		verboseprint(0,cvl,&quot;&lt;!&gt; Fichier cbz non valide : %s&quot; % inputfile) ;
		verboseprint(0,cvl,&quot;&lt;!&gt; Essai de unrar : %s&quot; % inputfile) ;
		os.system(&quot;unrar x %s&quot; %inputfile)
		#variable = &quot;CF_tome_03_017_scanddl.com.jpg&quot;
		#regex re.compile('[0-9]{2,5}')
		#regex = re.search('[0-9]{3sud,5}',variable)
		#if regex:
		#	print &quot;variable : &quot; , variable
		#	print &quot;donc : &quot;, regex.group()
		sys.exit(2)
		
	#print inputfile[:-4]
	[a,b]=[1,2]
	if  reversemode:[a,b]=[b,a]
	prefix= inputfile[:5]
	verboseprint(1,cvl, &quot;! Start&quot;)
	verboseprint(2,cvl, &quot;+ Creation du dossier temp - %s&quot; % rndfolder)
	makemydir(rndfolder)
	verboseprint(2,cvl, &quot;+-&gt;Creation ok&quot;)
	verboseprint(2,cvl, &quot;+ Extraction de %s&quot; % inputfile)
	z.extractall(rndfolder)
	verboseprint(2,cvl, &quot;+-&gt; Extraction de ok&quot;)
	os.chdir(rndfolder)

	
	for dirname, dirnames, filenames in os.walk('.'):
	    for filename in filenames:
			verboseprint(1,cvl, &quot;+ Traitement - %s&quot; % os.path.join(dirname, filename))
			#test du convertbw
			verboseprint(1,cvl,conversionbw(os.path.join(dirname, filename),convertbw))
			#test du startpage
			
			#a attraper si y a pas de compteur !
			try:
				#mega test de la mort
				obvious_string = int(filename[-7:-4])
				if (int(filename[-7:-4]) &lt;= startpage):  
					verboseprint(2,cvl, &quot;+--Image non decoupee&quot;)
					ficname = prefix+str(filename[-7:-4]) +&quot;0&quot; +&quot;.jpg&quot;
					os.rename(os.path.join(dirname, filename), ficname)
					verboseprint(2,cvl, &quot;+-&gt;Sauvegarde - %s&quot; % ficname)
					verboseprint(1,cvl, &quot;+ Rajout a l'archive  - %s&quot; % ficname)
					with zipfile.ZipFile(racine + rndarchive, 'a') as myzip:
						myzip.write(os.path.join(ficname),inputfile[:-4] + os.path.sep +os.path.join(ficname),zipfile.ZIP_DEFLATED)    
						#myzip.write(os.path.join(ficname),inputfile[:-4] + os.path.sep +os.path.join(ficname),zipfile.ZIP_DEFLATED)    
					verboseprint(2,cvl, &quot;+-&gt;Rajout ok&quot;)				
				else:
					img = Image.open(os.path.join(dirname, filename))
					width, height = img.size
					if (width &gt;  height) :
						verboseprint(2,cvl, &quot;+--Infos : Paysage | W : %i px H : %i px&quot; %( width , height))
						box = (0, 0, width/2, height)
						area = img.crop(box)
						ficname = prefix+str(filename[-7:-4]) +str(a)+ &quot;.jpg&quot; 
						area.save(ficname, 'jpeg')
						verboseprint(2,cvl, &quot;+-&gt;Sauvegarde - %s&quot; % ficname)
						verboseprint(1,cvl, &quot;+ Rajout a l'archive  - %s&quot; % ficname)
						with zipfile.ZipFile(racine + rndarchive, 'a') as myzip:
							myzip.write(os.path.join(ficname),inputfile[:-4] + os.path.sep +os.path.join(ficname),zipfile.ZIP_DEFLATED)    
						verboseprint(2,cvl, &quot;+-&gt;Rajout ok&quot;)
						box = (width/2, 0, width, height)
						area = img.crop(box)
						ficname = prefix+str(filename[-7:-4]) +str(b) + &quot;.jpg&quot; 
						area.save(ficname, 'jpeg')
						verboseprint(2,cvl, &quot;+-&gt;Sauvegarde - %s&quot; % ficname)
						verboseprint(1,cvl, &quot;+ Rajout a l'archive  - %s&quot; % ficname)
						with zipfile.ZipFile(racine + rndarchive, 'a') as myzip:
							#myzip.write(os.path.join(ficname))
							myzip.write(os.path.join(ficname),inputfile[:-4] + os.path.sep +os.path.join(ficname),zipfile.ZIP_DEFLATED)    
						verboseprint(2,cvl, &quot;+-&gt;Rajout ok&quot;)
					else:
						verboseprint(2,cvl, &quot;+--Infos : Portrait | W : %i px H : %i px&quot; %( width , height))
						ficname = prefix+str(filename[-7:-4]) +&quot;0&quot; +&quot;.jpg&quot;
						os.rename(os.path.join(dirname, filename), ficname)
						verboseprint(2,cvl, &quot;+-&gt;Sauvegarde - %s&quot; % ficname)
						verboseprint(1,cvl, &quot;+ Rajout a l'archive  - %s&quot; % ficname)
						with zipfile.ZipFile(racine + rndarchive, 'a') as myzip:
							#myzip.write(os.path.join(ficname))    
							myzip.write(os.path.join(ficname),inputfile[:-4] + os.path.sep + os.path.join(ficname),zipfile.ZIP_DEFLATED)    
						verboseprint(2,cvl, &quot;+-&gt;Rajout ok&quot;)
			except ValueError:
				verboseprint(2,cvl, &quot;+-&gt;Sauvegarde - %s&quot; % filename)
				verboseprint(1,cvl, &quot;+ Rajout a l'archive  - %s&quot; % filename)
				with zipfile.ZipFile(racine + rndarchive, 'a') as myzip:
					myzip.write(os.path.join(dirname, filename),inputfile[:-4] + os.path.sep + os.path.join(filename),zipfile.ZIP_DEFLATED)    
					#myzip.write(os.path.join(ficname),inputfile[:-4] + os.path.sep +os.path.join(ficname),zipfile.ZIP_DEFLATED)    
				verboseprint(2,cvl, &quot;+-&gt;Rajout ok&quot;)	
				

			
			
			
	
	
	#renommer le fichier d'orgine
	os.rename(fullpathfile,racine + &quot;old_&quot;+inputfile)
	#renommer l'archive en fichier d'origine
	os.rename(racine + rndarchive,fullpathfile[:-4]+&quot;.cbz&quot;)
	
	#regex re.compile('[0-9]{2,5}')
	#re.search(variable)
	os.chdir(racine)
	verboseprint(2,cvl, &quot;+ Suppression du dossier temp - %s&quot; % rndfolder)
	shutil.rmtree(rndfolder)
	verboseprint(2,cvl, &quot;+-&gt;Suppression ok&quot;)
	verboseprint(1,cvl, &quot;! End&quot;)

racine= os.getcwd() + &quot;/&quot;
rndfolder = os.getcwd() + &quot;/&quot; + id_generator()
rndarchive = id_generator()
retval = os.getcwd()

if __name__ == &quot;__main__&quot;:
	main(sys.argv[1:])

</pre>
</noscript><div class="admonition-a-noter admonition">
<p class="first admonition-title"><strong>A noter:</strong></p>
<ul class="last simple">
<li>Utilise les libs zip et rar, et prendre l'un pour l'autre bloque la kobo... méfiance</li>
<li>Détection du rar pas fiable</li>
</ul>
</div>
